{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-1">{{ title }}</h1>
    <p class="text-muted">
        Conversation with:
        {% if current_user.id == conversation.user_id %}
            Admin {{ conversation.admin.username }}
        {% else %}
            User {{ conversation.user.username }}
        {% endif %}
        | Status: <span class="fw-bold">{{ conversation.status.value }}</span>
    </p>
    <hr>

    <div id="message-list" class="mb-4" style="max-height: 500px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px; background-color: #f9f9f9;" aria-live="polite">
        {% if messages %}
            {% for message in messages %}
            <div class="card mb-2 {% if message.sender_id == current_user.id %}ms-auto bg-primary text-white{% else %}me-auto bg-light{% endif %} w-100 w-md-75"
                 style="{% if message.sender_id == current_user.id %}border-top-right-radius: 0;{% else %}border-top-left-radius: 0;{% endif %}">
                <div class="card-body p-2">
                    <p class="card-text mb-1" style="white-space: pre-wrap;">{{ message.body|safe }}</p>
                    <small class="{% if message.sender_id == current_user.id %}text-light-emphasis{% else %}text-muted{% endif %}" style="font-size: 0.75rem;">
                        {{ message.sender.username }} - {{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-muted">No messages in this conversation yet.</p>
        {% endif %}
        <div id="bottom-of-chat-marker"></div> {# Marker to scroll to #}
    </div>

    {% if conversation.status == ConversationStatus.OPEN %}
    <hr>
    <h4>Reply:</h4>
    <form method="POST" action="{{ url_for('messaging.view_conversation', conversation_id=conversation.id) }}" novalidate>
        {{ form.hidden_tag() }}
        {{ wtf.render_field(form.body, rows=4, placeholder="Type your reply...") }}
        {{ wtf.render_field(form.submit, button_map={'submit': 'btn-primary'}) }}
    </form>

    <form method="POST" action="{{ url_for('messaging.close_conversation_route', conversation_id=conversation.id) }}" class="mt-3" onsubmit="return confirm('Are you sure you want to close this conversation? You will not be able to send more messages.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="submit" value="Close Conversation" class="btn btn-sm btn-outline-danger">
    </form>

    {% else %}
    <div class="alert alert-info mt-3" role="alert">
        This conversation is closed (Status: {{ conversation.status.value }}). You can no longer send messages.
    </div>
    {% endif %}

    <div class="mt-4">
        {% if current_user.role == UserRole.ADMIN %}
            <a href="{{ url_for('messaging.admin_list_all_conversations') }}" class="btn btn-secondary">Back to Admin Conversations</a>
        {% else %}
            <a href="{{ url_for('messaging.list_my_conversations') }}" class="btn btn-secondary">Back to My Messages</a>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var chatWindow = document.getElementById('message-list');
        var bottomMarker = document.getElementById('bottom-of-chat-marker');
        if (chatWindow && bottomMarker) {
            bottomMarker.scrollIntoView();
        }
    });
</script>
{% endblock %}
