{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ title }}</h1>

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">Ticket ID: {{ ticket.id }}</span>
                <span class="badge text-bg-{{
                    'warning' if ticket.status == TicketStatus.OUTSTANDING or ticket.status == TicketStatus.RESOLVED_UNPAID
                    else 'success' if ticket.status == TicketStatus.PAID or ticket.status == TicketStatus.RESOLVED_DISMISSED
                    else 'info' if ticket.status == TicketStatus.CONTESTED
                    else 'secondary' }}">
                    {{ ticket.status.value }}
                </span>
            </div>
        </div>

        <div class="card-body">
            <div class="mb-3">
                <p><strong>Issued To:</strong> {{ ticket.issued_to.username if ticket.issued_to else 'N/A' }}</p>
                <p><strong>Issued By:</strong> Officer {{ ticket.issued_by.username if ticket.issued_by else 'System/Unknown' }}</p>
                <p><strong>Vehicle ID:</strong> {{ ticket.vehicle_id|default('N/A', True) }}</p>
                <p><strong>Fine Amount:</strong> {{ "%.2f"|format(ticket.fine_amount) }} {{ current_user.accounts.first().currency if current_user.accounts.first() else '' }}</p>
                <p><strong>Issue Date:</strong> {{ ticket.issue_date.strftime('%Y-%m-%d %H:%M:%S UTC') if ticket.issue_date else 'N/A' }}</p>
                <p><strong>Due Date:</strong> {{ ticket.due_date.strftime('%Y-%m-%d %H:%M:%S UTC') if ticket.due_date else 'N/A' }}</p>
            </div>

            <div class="mb-3">
                <h5 class="mb-1">Violation Details:</h5>
                <div class="bg-light p-3 rounded border text-dark">{{ ticket.violation_details|safe }}</div>
            </div>

            {% if ticket.user_contest_reason %}
            <div class="mb-3">
                <h5 class="mb-1">Your Reason for Contesting:</h5>
                <div class="bg-light p-3 rounded border text-dark">{{ ticket.user_contest_reason|safe }}</div>
            </div>
            {% endif %}

            {% if ticket.resolution_notes %}
            <div class="mb-3">
                <h5 class="mb-1">Admin Resolution Notes:</h5>
                <div class="bg-light p-3 rounded border text-dark">
                    {{ ticket.resolution_notes|safe }}
                    <br><small class="text-muted">Resolved by: {{ ticket.resolved_by_admin.username if ticket.resolved_by_admin else 'Admin' }}</small>
                </div>
            </div>
            {% endif %}

            {% if ticket.status == TicketStatus.PAID and ticket.payment_transaction %}
            <div class="mb-3">
                <h5 class="mb-1">Payment Information:</h5>
                <p>Paid on: {{ ticket.payment_transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                <p>Banking Transaction ID: {{ ticket.banking_transaction_id }}</p>
            </div>
            {% endif %}
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            {% if ticket.issued_to_user_id == current_user.id %}
                {% if ticket.status == TicketStatus.OUTSTANDING or ticket.status == TicketStatus.RESOLVED_UNPAID %}
                <form method="POST" action="{{ url_for('dot.pay_ticket', ticket_id=ticket.id) }}" onsubmit="return confirm('Are you sure you want to pay this fine? The amount will be deducted from your bank account.');">
                    <button type="submit" class="btn btn-success">Pay Fine ({{ "%.2f"|format(ticket.fine_amount) }})</button>
                </form>
                {% endif %}
                {% if ticket.status == TicketStatus.OUTSTANDING %}
                <a href="{{ url_for('dot.contest_ticket', ticket_id=ticket.id) }}" class="btn btn-warning">Contest Ticket</a>
                {% endif %}
                <a href="{{ url_for('dot.my_tickets') }}" class="btn btn-secondary">Back to My Tickets</a>

            {% elif current_user.role == UserRole.OFFICER and ticket.issued_by_officer_id == current_user.id %}
                <a href="{{ url_for('dot.list_issued_tickets') }}" class="btn btn-secondary">Back to My Issued Tickets</a>

            {% elif current_user.role == UserRole.ADMIN %}
                <a href="{{ url_for('admin.manage_tickets') }}" class="btn btn-secondary">Back to Admin Ticket List</a>
                {% if ticket.status in [TicketStatus.CONTESTED, TicketStatus.OUTSTANDING] %}
                <a href="{{ url_for('admin.resolve_ticket', ticket_id=ticket.id) }}" class="btn btn-primary">Resolve/Update (Admin)</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
