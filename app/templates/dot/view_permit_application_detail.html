{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ title }}</h1>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Application ID: {{ application.id }}</span>
                <span class="badge badge-lg badge-{{
                    'primary' if application.status == PermitApplicationStatus.PENDING_REVIEW
                    else 'info' if application.status == PermitApplicationStatus.REQUIRES_MODIFICATION
                    else 'warning' if application.status == PermitApplicationStatus.APPROVED_PENDING_PAYMENT
                    else 'secondary' if application.status == PermitApplicationStatus.PAID_AWAITING_ISSUANCE
                    else 'success' if application.status == PermitApplicationStatus.ISSUED
                    else 'danger' if application.status == PermitApplicationStatus.REJECTED or application.status == PermitApplicationStatus.CANCELLED_BY_ADMIN
                    else 'dark' if application.status == PermitApplicationStatus.CANCELLED_BY_USER
                    else 'light' }}">
                    Status: {{ application.status.value }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <p><strong>Applicant:</strong> {{ application.applicant.username if application.applicant else 'N/A' }}</p>
            <p><strong>Application Date:</strong> {{ application.application_date.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            <hr>
            <h5 class="mt-3">Permit Details:</h5>
            <p><strong>Vehicle Type/Description:</strong> {{ application.vehicle_type }}</p>
            <p><strong>Proposed Route:</strong><br>{{ application.route_details|safe|nl2br }}</p>
            <p><strong>Travel Start Date:</strong> {{ application.travel_start_date.strftime('%Y-%m-%d') }}</p>
            <p><strong>Travel End Date:</strong> {{ application.travel_end_date.strftime('%Y-%m-%d') }}</p>

            {% if application.user_notes %}
            <h5 class="mt-3">User Notes:</h5>
            <p class="bg-light p-2 rounded">{{ application.user_notes|safe|nl2br }}</p>
            {% endif %}

            {% if application.officer_notes %}
            <h5 class="mt-3">Officer/Admin Notes:</h5>
            <p class="bg-light p-2 rounded">
                {{ application.officer_notes|safe|nl2br }}
                {% if application.reviewer_officer %}
                <br><small class="text-muted">Reviewed by: {{ application.reviewer_officer.username }}</small>
                {% endif %}
            </p>
            {% endif %}

            {% if application.status == PermitApplicationStatus.APPROVED_PENDING_PAYMENT or application.permit_fee %}
            <h5 class="mt-3">Permit Fee:</h5>
            <p><strong>{{ "%.2f"|format(application.permit_fee) }} {{ current_user.accounts.first().currency if current_user.accounts.first() else '' }}</strong></p>
            {% endif %}

            {% if application.status == PermitApplicationStatus.PAID_AWAITING_ISSUANCE and application.payment_transaction %}
            <h5 class="mt-3">Payment Information:</h5>
            <p>Paid on: {{ application.payment_transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            <p>Banking Transaction ID: {{ application.banking_transaction_id }}</p>
            {% endif %}

            {% if application.status == PermitApplicationStatus.ISSUED %}
            <h5 class="mt-3 text-success">Permit Issued!</h5>
            <p><strong>Issued Permit ID:</strong> <span class="font-weight-bold">{{ application.issued_permit_id_str }}</span></p>
            <p><strong>Issued On:</strong> {{ application.issued_on_date.strftime('%Y-%m-%d %H:%M:%S UTC') if application.issued_on_date else 'N/A' }}</p>
            <p><strong>Issued By:</strong> {{ application.issuer_officer.username if application.issuer_officer else 'System/Admin' }}</p>
            <div class="alert alert-success">This permit is valid from {{ application.travel_start_date.strftime('%Y-%m-%d') }} to {{ application.travel_end_date.strftime('%Y-%m-%d') }}. Please keep this ID for reference.</div>
            {% endif %}

        </div>
        <div class="card-footer text-right">
            {# User Actions #}
            {% if application.user_id == current_user.id %}
                {% if application.status == PermitApplicationStatus.APPROVED_PENDING_PAYMENT %}
                    <form method="POST" action="{{ url_for('dot.pay_for_permit', application_id=application.id) }}" style="display:inline;" onsubmit="return confirm('Confirm payment of {{ "%.2f"|format(application.permit_fee) }} for this permit?');">
                        <input type="submit" value="Pay Permit Fee ({{ "%.2f"|format(application.permit_fee) }})" class="btn btn-success">
                    </form>
                {% endif %}
                {% if application.status == PermitApplicationStatus.PENDING_REVIEW or application.status == PermitApplicationStatus.REQUIRES_MODIFICATION %}
                    <form method="POST" action="{{ url_for('dot.cancel_permit_application_by_user', application_id=application.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to cancel this permit application?');">
                        <input type="submit" value="Cancel My Application" class="btn btn-danger">
                    </form>
                    {# Add Edit button if status is REQUIRES_MODIFICATION #}
                    {% if application.status == PermitApplicationStatus.REQUIRES_MODIFICATION %}
                         <!-- <a href="{{ url_for('dot.edit_my_application', application_id=application.id) }}" class="btn btn-warning">Edit Application</a> -->
                    {% endif %}
                {% endif %}
                <a href="{{ url_for('dot.my_permit_applications') }}" class="btn btn-secondary">Back to My Applications</a>
            {% endif %}

            {# Officer/Admin Actions - Show if current user is officer/admin AND not the applicant #}
            {% if current_user.role in [UserRole.OFFICER, UserRole.ADMIN] and application.user_id != current_user.id %}
                 <a href="{{ url_for('dot.review_permit_applications_list') }}" class="btn btn-secondary">Back to Review List</a>
                {% if application.status in [PermitApplicationStatus.PENDING_REVIEW, PermitApplicationStatus.REQUIRES_MODIFICATION] %}
                    <a href="{{ url_for('dot.review_permit_application', application_id=application.id) }}" class="btn btn-primary">Review/Process Application</a>
                {% endif %}
                 {% if application.status == PermitApplicationStatus.PAID_AWAITING_ISSUANCE %}
                    <form method="POST" action="{{ url_for('dot.issue_final_permit', application_id=application.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to mark this permit as officially ISSUED?');">
                        <input type="submit" value="Issue Final Permit" class="btn btn-success">
                    </form>
                 {% endif %}
            {# Admin viewing their own application (edge case, admin usually doesn't apply for self) #}
            {% elif current_user.role == UserRole.ADMIN and application.user_id == current_user.id %}
                 <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">Back to Admin Panel</a>
                 {% if application.status in [PermitApplicationStatus.PENDING_REVIEW, PermitApplicationStatus.REQUIRES_MODIFICATION, PermitApplicationStatus.PAID_AWAITING_ISSUANCE] %}
                    <span class="text-muted small"> (As admin, manage this application via Officer Review List if needed)</span>
                 {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
