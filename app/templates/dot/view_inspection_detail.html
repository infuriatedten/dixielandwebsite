{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ title }}</h1>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Inspection ID: {{ inspection.id }}</span>
                <span class="badge badge-lg badge-{{ 'success' if inspection.pass_status else 'danger' }}">
                    Result: {{ 'Pass' if inspection.pass_status else 'Fail' }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <p><strong>Vehicle ID:</strong> {{ inspection.vehicle_id }}</p>
            <p><strong>Inspected User:</strong> {{ inspection.inspected_user.username if inspection.inspected_user else 'N/A (Not Linked to Registered User)' }}</p>
            <p><strong>Inspecting Officer:</strong> {{ inspection.officer.username if inspection.officer else 'N/A' }}</p>
            <p><strong>Date & Time of Inspection:</strong> {{ inspection.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if inspection.timestamp else 'N/A' }}</p>

            <h5 class="mt-3">Officer's Notes:</h5>
            <p class="bg-light p-3 rounded">{{ inspection.notes|default('No notes provided.', True)|safe|nl2br }}</p>
        </div>
        <div class="card-footer text-right">
            {% if not inspection.pass_status and current_user.role in [UserRole.OFFICER, UserRole.ADMIN] %}
                {# Prepare URL parameters for pre-filling ticket form #}
                {% set ticket_params = {
                    'vehicle_id': inspection.vehicle_id,
                    'violation_details': 'Failed DOT Inspection #' ~ inspection.id ~ ' on ' ~ inspection.timestamp.strftime('%Y-%m-%d') ~ ' for vehicle ' ~ inspection.vehicle_id ~ '.\nReason: ' ~ (inspection.notes|truncate(100, True) if inspection.notes else 'See inspection notes.'),
                    'fine_amount': 100.00  # Example default fine, officer can change
                } %}
                {% if inspection.inspected_user %}
                    {% set_ticket_params = ticket_params.update({'user_search': inspection.inspected_user.username}) %}
                {% endif %}
                <a href="{{ url_for('dot.issue_ticket', **ticket_params) }}" class="btn btn-danger">Issue Ticket for Failed Inspection</a>
            {% endif %}

            {% if current_user.role == UserRole.OFFICER %}
                <a href="{{ url_for('dot.list_my_conducted_inspections') }}" class="btn btn-secondary">Back to My Inspections</a>
            {% elif current_user.role == UserRole.ADMIN %}
                <a href="{{ url_for('admin.manage_inspections') }}" class="btn btn-secondary">Back to All Inspections (Admin)</a>
            {% elif inspection.inspected_user_id == current_user.id %}
                {# <a href="{{ url_for('user.my_vehicle_inspections') }}" class="btn btn-secondary">Back to My Vehicle Inspections</a> #}
                {# Placeholder for user view if implemented #}
                 <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to Home</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
