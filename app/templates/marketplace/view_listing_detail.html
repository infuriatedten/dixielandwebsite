{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-2">{{ listing.item_name }}</h1>
            <p class="text-muted">
                Listed by: {{ listing.seller.username }}
                {% if listing.seller.discord_username %}
                    (Discord: {{ listing.seller.discord_username }})
                {% endif %}
                on {{ listing.creation_date.strftime('%Y-%m-%d %H:%M') }}
            </p>
            <hr>

            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Listing Details</h4>
                    <span class="badge bg-{{
                        'success' if listing.status == MarketplaceListingStatus.AVAILABLE
                        else 'info' if listing.status == MarketplaceListingStatus.SOLD_MORE_AVAILABLE
                        else 'secondary' if listing.status == MarketplaceListingStatus.SOLD_OUT
                        else 'danger' if listing.status == MarketplaceListingStatus.CANCELLED
                        else 'light' }}">
                        {{ listing.status.value }}
                    </span>
                </div>
                <div class="card-body">
                    <p>
                        <strong>Price:</strong>
                        <span class="text-success fw-bold h5">
                            {{ "%.2f"|format(listing.price) }}
                            {{ listing.seller.accounts.first().currency if listing.seller.accounts.first() else 'GDC' }}
                        </span>
                    </p>

                    <p><strong>Quantity Available:</strong> {{ listing.quantity }} {{ listing.unit }}</p>

                    <h5 class="mt-4">Description:</h5>
                    <p class="bg-light p-3 rounded">
                        {{ listing.description|default('No detailed description provided.', True)|safe|nl2br }}
                    </p>

                    {% if listing.discord_message_id %}
                    <p class="small text-muted">
                        Discord Message ID: {{ listing.discord_message_id }} (For bot use)
                    </p>
                    {% endif %}
                </div>

                {% if current_user.is_authenticated and (current_user.id == listing.seller_user_id or current_user.role == UserRole.ADMIN) %}
                <div class="card-footer">
                    <h5>Manage Listing</h5>

                    {% if listing.status in [MarketplaceListingStatus.AVAILABLE, MarketplaceListingStatus.SOLD_MORE_AVAILABLE] %}
                    <a href="{{ url_for('marketplace.edit_listing', listing_id=listing.id) }}"
                       class="btn btn-warning btn-sm me-2 mb-2">
                        Edit Listing
                    </a>
                    {% endif %}

                    <form method="POST"
                          action="{{ url_for('marketplace.update_listing_status', listing_id=listing.id) }}"
                          class="row g-2 align-items-center">

                        <div class="col-auto">
                            <label class="visually-hidden" for="new_status_select">Update Status</label>
                            <select name="new_status" id="new_status_select" class="form-select form-select-sm">
                                {% if listing.status == MarketplaceListingStatus.AVAILABLE %}
                                    <option value="SOLD_MORE_AVAILABLE">Mark as Sold (More Available)</option>
                                    <option value="SOLD_OUT">Mark as Sold Out (All Gone)</option>
                                {% elif listing.status == MarketplaceListingStatus.SOLD_MORE_AVAILABLE %}
                                    <option value="AVAILABLE">Mark as Available Again</option>
                                    <option value="SOLD_OUT">Mark as Sold Out (All Gone)</option>
                                {% endif %}
                                {% if listing.status not in [MarketplaceListingStatus.CANCELLED, MarketplaceListingStatus.SOLD_OUT] %}
                                    <option value="CANCELLED">Cancel Listing</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary btn-sm">
                                Update Status
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
                <a href="{{ url_for('marketplace.index') }}" class="btn btn-secondary">Back to Marketplace</a>
                {% if current_user.is_authenticated and current_user.id == listing.seller_user_id %}
                <a href="{{ url_for('marketplace.my_listings') }}" class="btn btn-outline-secondary">My Other Listings</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
