# Game Portal & DOT Management System

## Overview

This project is a comprehensive web application designed for an in-game economy and Department of Transportation (DOT) management. It provides functionalities for users to view banking information, pay taxes (automated), manage tickets, apply for vehicle permits, and list items on a marketplace with Discord integration. DOT officers and administrators have dedicated interfaces to manage these systems.

The application is built with Python using the Flask framework and MySQL as the database.

## Features

### 1. Core System
-   **User Authentication:** Registration, login, logout, profile management.
-   **Role-Based Access Control:** Distinct functionalities for Regular Users, DOT Officers, and Administrators.

### 2. Banking Information Module
-   **Admin Managed:** Admins manually set up and update user bank account balances and transaction histories.
-   **User View:** Users can view their current balance, transaction history, and generate account statements.

### 3. Automated Tax Module
-   **Admin Defined Brackets:** Admins can define tax brackets based on account balances (percentage-based tax rate).
-   **Weekly Automated Deduction:** A scheduled job (designed for Render Cron Jobs) automatically deducts taxes from user accounts weekly based on their balance and applicable tax bracket.
-   **User Transparency:** Users can view active tax brackets and their personal tax deduction history.

### 4. Ticket Payment & Management Module (DOT)
-   **Officer Issuance:** DOT Officers can issue tickets to users for violations, specifying vehicle ID, violation details, and fine amount. Due dates are automatically set to 72 hours.
-   **User Management:** Users can view their tickets, pay outstanding fines (deducted from their game bank account), or contest tickets.
-   **Admin Resolution:** Admins can review contested tickets, update their status (e.g., fine upheld, dismissed), and cancel tickets.

### 5. Permit Application Module (Vehicle Movement - DOT)
-   **User Application:** Users can apply for permits to move specific vehicles, providing details like vehicle type, route, and travel dates.
-   **Officer/Admin Review:** DOT Officers/Admins review applications. They can approve (and set a permit fee), request modifications, or reject applications.
-   **Payment & Issuance:** Users pay the fee for approved permits from their game bank account. Once paid, officers/admins can officially issue the permit, generating a unique permit ID.
-   **User Tracking:** Users can track the status of their permit applications.

### 6. Discord Integration Module (Marketplace - Phase 1)
-   **Website Listings:** Users can create, view, and manage marketplace listings for items they want to sell (item name, description, price, quantity, unit).
-   **Webhook to Discord:** New listings and status updates made via the website are automatically posted as messages to a configured Discord channel using a webhook.
-   **Future (Phase 2 - Not Implemented):**
    -   Linking website accounts with Discord User IDs via OAuth2.
    -   A Discord bot to handle commands from Discord (e.g., `!sold_out <listing_id>`) to update listing status, which would then reflect on the website.

### 7. DOT System - Inspections (Officer Facing)
-   **Officer Recording:** DOT Officers can record results of vehicle inspections (Vehicle ID, optional Inspected User, Pass/Fail status, notes).
-   **Failed Inspection to Ticket:** A failed inspection provides a direct link for the officer to pre-fill a new ticket for the inspected vehicle/user.
-   **Viewing Inspections:** Officers can view inspections they conducted. Admins can view all inspections.

### 8. Livemap Server Status (Phase 1)
-   **Data Source:** Reads `livemap_dynamic.xml` generated by an external game server mod (e.g., Farming Simulator Livemap).
-   **Access Methods:** Configurable to fetch XML data via SCP (Secure Copy Protocol) or by reading from a local path (if files are synced).
-   **Information Displayed:** Shows current server status to logged-in users, including Map Name, Player Count, Paused Status, Last XML Update Time, and Livemap/Game versions.
-   **Future (Not Implemented in this Phase):** Display of detailed live data like player/vehicle locations, full weather, field status. FTP access method for XML files. Database caching of Livemap data.

## Technology Stack
-   **Backend:** Python, Flask
-   **Database:** MySQL
-   **Frontend:** HTML, CSS, Bootstrap, JavaScript (minimal, primarily for Bootstrap components)
-   **WSGI Server (Production):** Gunicorn
-   **Static File Serving (Production):** WhiteNoise
-   **Scheduled Tasks:** Designed for Render Cron Jobs (for automated taxes).

## Local Development Setup

1.  **Prerequisites:**
    *   Python 3.9+ (ensure your specific minor version, e.g., 3.10, 3.11, 3.12)
    *   MySQL Server
    *   `pip` for package installation

2.  **Clone the Repository:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

3.  **Create a Virtual Environment (Recommended):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows: venv\Scripts\activate
    ```

4.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

5.  **Configure MySQL Database:**
    *   Ensure your MySQL server is running.
    *   Create a database for the application (e.g., `game_portal_db`). The `run.py` script will attempt `db.create_all()` which creates tables but not the database itself for MySQL.
    *   Open `config.py`.
    *   Update `SQLALCHEMY_DATABASE_URI` with your MySQL connection string:
        `'mysql+pymysql://YOUR_MYSQL_USER:YOUR_MYSQL_PASSWORD@YOUR_MYSQL_HOST/YOUR_DATABASE_NAME'`
        (Example for local: `'mysql+pymysql://root:your_local_mysql_password@localhost/game_portal_db'`)
        Alternatively, set the `DATABASE_URL` environment variable.

6.  **Configure Environment Variables (or update `config.py` directly for local dev):**
    *   **`SECRET_KEY`:** Generate a strong secret key. You can use:
        ```bash
        python -c "import secrets; print(secrets.token_hex(24))"
        ```
        Set this in `config.py` (replacing `'your_secret_key'`) or as an environment variable `SECRET_KEY`.
    *   **`DISCORD_WEBHOOK_URL` (Optional):** If you want to test marketplace posting to Discord, get a webhook URL from your Discord server and set it in `config.py` or as an environment variable `DISCORD_WEBHOOK_URL`.

7.  **Run the Application:**
    ```bash
    python run.py
    ```
    The application should be accessible at `http://localhost:5000` (or the port specified in `run.py`).
    An initial admin user (`username: admin`, `password: adminpassword`) will be created if one doesn't exist.

8.  **To Run the Tax Job Manually (for testing):**
    The automated tax job is designed for a cron scheduler. To test it locally:
    ```bash
    python run_tax_job.py
    ```
    This will execute the `apply_weekly_taxes` function. Ensure your `DATABASE_URL` (or equivalent in `config.py`) is set for this script to connect to the DB.

## Deployment to Render.com

This application is prepared for deployment on Render.com.

1.  **Push your code to a Git repository** (GitHub, GitLab).

2.  **On Render.com:**
    *   **Create a MySQL Database Service:**
        *   Choose a region and plan. Note the **Internal Connection String**.
    *   **Create a Web Service:**
        *   Connect your Git repository.
        *   Render should detect Python.
        *   **Build Command:** `pip install -r requirements.txt` (usually auto-detected).
        *   **Start Command:** `gunicorn run:app` (Render should pick this from the `Procfile`).
        *   **Environment Variables:**
            *   `DATABASE_URL`: Use the Internal Connection String from your Render MySQL service.
            *   `SECRET_KEY`: A strong, unique secret key.
            *   `PYTHON_VERSION`: Specify your Python version (e.g., `3.12.0`).
            *   `DISCORD_WEBHOOK_URL`: Your Discord webhook URL for the marketplace.
    *   **Create a Cron Job Service (for Weekly Taxes):**
        *   Connect the same Git repository.
        *   **Command:** `python run_tax_job.py`
        *   **Schedule:** e.g., `5 0 * * 0` (Every Sunday at 00:05 UTC).
        *   **Environment Variables:** Also add `DATABASE_URL` and `SECRET_KEY` here (and any other config the app context needs).

3.  **Deploy** your services on Render. Check logs for any issues.

**Note on Database Migrations:** The current setup uses `db.create_all()` which is suitable for initial setup. For production and ongoing schema changes, implementing database migrations using a tool like Flask-Migrate (Alembic) is highly recommended. This involves initializing Alembic in your project, generating migration scripts for schema changes, and applying them during deployment.

## Future Enhancements (Not Implemented in this Scope)
-   Full Discord bot integration for marketplace commands (`!sold_out`, etc.).
-   Discord OAuth2 for linking website accounts to Discord User IDs.
-   User-facing views for their vehicle inspection history.
-   In-app notification system for events like ticket issuance, permit status changes.
-   More detailed DOT Inspection types and criteria.
-   Advanced search and filtering capabilities for all modules.
-   File uploads (e.g., for permit supporting documents, item images for marketplace).
-   Direct user-to-user interaction/messaging system for marketplace transactions.

---
This `README.md` provides a comprehensive overview for setting up and deploying the application.
```
